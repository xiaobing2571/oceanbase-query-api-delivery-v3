# OceanBase 通用查询 API 服务 - Postman 测试指南

## 概述

本文档提供了使用 Postman 测试 OceanBase 通用查询 API 服务的详细指南。测试集合覆盖了所有主要接口和内置场景，包括数据源管理、场景管理、模板管理和查询执行等功能。

## 测试环境准备

在开始测试前，请确保：

1. **配置有效的数据库连接**：
   - 修改 `application.properties` 文件中的数据库连接信息
   - 默认配置使用的是占位符 `your-metadata-ob-host`，需替换为实际可用的数据库地址

   ```properties
   # 示例配置
   spring.datasource.url=jdbc:mysql://localhost:3306/query_api_metadata
   spring.datasource.username=root
   spring.datasource.password=password
   ```

2. **修改测试数据中的数据源配置**：
   - 编辑 `test-data.sql` 文件中的数据源配置，确保连接信息有效
   - 特别是 `ob-cluster-prod` 等预置数据源的连接信息

3. **启动应用**：
   - 使用开发环境配置启动应用：`mvn spring-boot:run -Dspring-boot.run.profiles=dev`
   - 确保应用成功启动并能访问 `http://localhost:8080`

## 导入 Postman 测试集合

1. 打开 Postman 应用
2. 点击 "Import" 按钮
3. 选择 `OceanBase_Query_API_Tests.postman_collection.json` 文件
4. 导入完成后，在左侧集合面板中可以看到 "OceanBase 通用查询 API 测试" 集合

## 配置环境变量

1. 在 Postman 中创建一个新环境（如 "OceanBase API 测试环境"）
2. 添加以下环境变量：
   - `baseUrl`: 设置为 API 服务的基础 URL，默认为 `http://localhost:8080`
   - `taskId`: 留空，将在测试过程中自动填充

## 运行测试

### 运行整个集合

1. 右键点击 "OceanBase 通用查询 API 测试" 集合
2. 选择 "Run collection"
3. 在运行配置中，确保选择了正确的环境
4. 点击 "Run" 按钮开始测试

### 运行特定文件夹

1. 右键点击特定文件夹（如 "数据源管理"）
2. 选择 "Run folder"
3. 配置运行选项并点击 "Run" 按钮

### 运行单个请求

1. 选择要测试的单个请求
2. 点击 "Send" 按钮发送请求
3. 查看响应和测试结果

## 测试集合结构

测试集合包含以下主要部分：

1. **数据源管理**：
   - 测试数据源连通性
   - 测试已注册数据源连通性

2. **场景管理**：
   - 获取所有场景
   - 注册新场景

3. **模板管理**：
   - 获取所有模板
   - 注册新模板

4. **查询执行**：
   - 执行集群状态监控场景（同步）
   - 执行性能诊断场景（同步）
   - 异步执行备份恢复监控场景
   - 获取异步任务结果

5. **内置场景测试**：
   - 执行合并监控场景
   - 执行租户资源使用场景

## 测试断言说明

每个请求都包含以下基本断言：

1. 验证响应状态码为 200
2. 验证响应格式为 JSON
3. 验证响应包含成功状态
4. 验证响应包含预期的数据结构

部分请求还包含特定断言，例如：

- 验证是否包含预置的场景或模板
- 验证异步任务是否返回任务 ID
- 验证查询结果是否为数组类型

## 测试数据依赖

测试集合中的某些请求依赖于其他请求的执行结果：

1. "获取异步任务结果" 依赖于 "异步执行备份恢复监控场景" 返回的任务 ID
2. "注册新场景" 使用了预置模板 ID，需确保这些模板已存在

## 故障排除

如果测试失败，请检查：

1. **数据库连接问题**：
   - 确认数据库服务是否正常运行
   - 验证连接字符串、用户名和密码是否正确
   - 检查网络连接是否通畅

2. **应用启动问题**：
   - 查看应用日志，确认是否有错误信息
   - 确保应用端口未被占用

3. **数据问题**：
   - 确认测试数据是否已正确导入
   - 验证预置的场景和模板是否存在

4. **请求参数问题**：
   - 检查请求体中的参数是否符合 API 要求
   - 确认 JSON 格式是否正确

## 自定义测试

您可以根据需要扩展测试集合：

1. 复制现有请求并修改参数
2. 添加新的测试断言
3. 创建新的测试场景
4. 添加环境变量以支持不同的测试环境

## 注意事项

1. 测试前请确保数据库中已导入测试数据
2. 异步任务测试可能需要等待一段时间才能获取结果
3. 某些测试可能依赖于特定的数据库版本或表结构
4. 在生产环境测试前，请确保使用只读操作或测试数据库
